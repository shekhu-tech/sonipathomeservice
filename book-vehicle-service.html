<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonipatHomeService.com - Premium Vehicle Booking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            /* Premium Dark Teal & Gold Theme (Matching AC Service File) */
            --bg-dark: #101827; /* Deep Space Black */
            --bg-card: #1C2738; /* Dark Navy Card */
            --primary: #00FFFF; /* Electric Teal Accent */
            --secondary: #FFC72C; /* Sunset Gold Accent */
            --text-light: #E0E7FF; /* Off-White Text */
            --text-subtle: #A0AEC0; /* Gray-Blue Subtle Text */
            --shadow-depth: 0 10px 30px rgba(0, 0, 0, 0.5);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 1.5rem;
        }

        /* --- Custom Components --- */

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-depth);
            transition: var(--transition);
            border: 1px solid rgba(0, 255, 255, 0.1); /* Teal border subtle */
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.2);
        }

        .stat-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .stat-card p {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
        }

        .product-section {
            background: linear-gradient(135deg, var(--bg-card), #22324C); 
            border-radius: 1.5rem;
            box-shadow: var(--shadow-depth);
            margin-bottom: 3rem;
            overflow: hidden;
            border: 2px solid var(--secondary);
        }

        .product-header {
            background: linear-gradient(90deg, #101827, #22324C);
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .product-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .product-content {
            display: flex;
            flex-wrap: wrap;
            padding: 3rem;
            gap: 3rem;
            align-items: center; 
            justify-content: center;
        }

        .product-details {
            flex: 1; 
            min-width: 300px;
            text-align: center; 
        }

        .price-container {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 1.5rem;
            margin: 1.5rem 0;
            padding: 1rem 0;
            border-top: 1px dashed var(--text-subtle);
            border-bottom: 1px dashed var(--text-subtle);
            justify-content: center; 
        }

        .original-price {
            font-size: 1.2rem;
            text-decoration: line-through;
            color: var(--text-subtle);
            font-weight: 400;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            justify-content: center;
        }

        .btn {
            padding: 0.8rem 1.8rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
            justify-content: center;
            flex-grow: 1;
            max-width: 300px;
            min-width: 150px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-primary:hover {
            background: #00D5D5; 
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.5); 
        }

        .btn-secondary {
            background: transparent;
            color: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-secondary:hover {
            background: rgba(255, 199, 44, 0.1); 
            transform: scale(1.03);
        }

        /* --- Popup Styling --- */
        #popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 999;
        }

        .popup {
            display: none;
            background: var(--bg-card);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-depth);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 95%;
            max-width: 650px;
            max-height: 95vh;
            overflow-y: auto;
            animation: fadeIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
            border: 1px solid var(--primary);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .popup h2 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--secondary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .popup label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.4rem;
            color: var(--primary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .popup input,
        .popup select,
        .popup textarea {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border-radius: 0.75rem;
            border: 1px solid var(--text-subtle);
            font-size: 1rem;
            background: #22324C; 
            color: var(--text-light);
            transition: border-color 0.3s ease;
        }
        
        .popup input:focus,
        .popup select:focus,
        .popup textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2); 
        }

        .popup textarea {
            min-height: 8rem;
            resize: vertical;
        }

        .popup button[type="submit"],
        #razorpay-payment-btn,
        #downloadTicketsBtn,
        .popup button.close-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: 'Montserrat', sans-serif;
        }

        .popup button[type="submit"],
        #razorpay-payment-btn,
        #downloadTicketsBtn {
            background: linear-gradient(45deg, var(--primary), #00D5D5); 
            color: var(--bg-dark);
        }

        .popup button[type="submit"]:hover,
        #razorpay-payment-btn:hover,
        #downloadTicketsBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 255, 255, 0.6); 
        }
        
        .quantity-selector-container {
            background: #22324C;
            padding: 1.2rem;
            border-radius: 0.75rem;
            border: 1px solid var(--text-subtle);
        }

        .total-price-quantity {
            font-size: 1.8rem !important;
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary) !important;
        }

        #selectedServiceCategoriesDisplay {
            background: var(--bg-dark);
            color: var(--text-light);
            border: 1px solid var(--primary);
            cursor: pointer;
        }
        
        /* Service Type Radio Buttons - Retained structure but not used for Vehicle Booking */
        .service-type-radio {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            /* Hide since Night Stay is now a dropdown */
            display: none; 
        }

        #ticketDisplay {
            background: #22324C;
            border: 1px solid var(--primary);
            color: var(--text-light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            word-break: break-word;
        }
        
        /* Custom Alert Styling */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary);
            color: var(--bg-dark);
            padding: 1.25rem 1.875rem;
            border-radius: 0.625rem;
            z-index: 1002;
            box-shadow: 0 0.3125rem 0.9375rem rgba(0,0,0,0.4);
            font-size: 1rem;
            text-align: center;
            max-width: 90%;
            animation: fadeInOut 4s forwards;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            10% { opacity: 1; transform: translate(-50%, -50%); }
            90% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); display: none; }
        }

        /* Price List Specific */
        #priceListTableBody tr:nth-child(even) {
            background-color: #22324C;
        }
        #priceListTableBody td {
            font-family: 'Roboto', sans-serif;
        }
        #priceListTableBody .font-semibold {
            color: var(--secondary);
            font-weight: 700;
        }

        /* --- RESPONSIVENESS TWEAKS --- */

        @media (max-width: 1024px) {
            .product-content { padding: 2rem; flex-direction: column; }
            .product-details { text-align: center; }
            .price-container, .action-buttons { justify-content: center; }
            .btn { max-width: 400px; } 
            .stat-grid { grid-template-columns: 1fr 1fr; }
            main { padding: 3rem 1rem; }
        }

        @media (max-width: 600px) {
            main { padding: 2rem 1rem; }
            .product-header h2 { font-size: 2rem; }
            .product-details h3 { font-size: 2rem; }
            .stat-grid { grid-template-columns: 1fr; gap: 1rem;} 
            .current-price { font-size: 2.5rem; }
            .popup { padding: 1.5rem; }
            .popup h2 { font-size: 1.5rem; }
            .action-buttons { flex-direction: column; }
            .btn { min-width: 100%; max-width: 100%; }
            
            #serviceCategorySelectionPopup {
                width: 98%;
                padding: 1rem;
            }
            #serviceCategoryCheckboxes {
                grid-template-columns: 1fr; 
            }
            .popup input, .popup select, .popup textarea {
                padding: 0.7rem 1rem;
            }
        }
        
        @media (max-width: 400px) {
            .current-price { font-size: 2rem; }
            .original-price { font-size: 1rem; }
            .stat-card p { font-size: 1.8rem; }
            .popup { padding: 1rem; }
        }
    </style>
</head>
<body>
   
    <main class="container">
        
        <section class="product-section">
            <div class="product-header">
                <h2 class="text-white">Premium Vehicle Booking & Rental</h2>
                <p class="text-sm text-gray-400 mt-2">Your Journey, Our Fleet. Luxury, Comfort, and Capacity for Every Trip..</p>
                <p class="text-sm text-gray-400 mt-2">We provide the perfect vehicle for every travel need. From sophisticated business travel to large family vacations, our diverse fleet of luxury cars, tempo travelers, and specialty vehicles ensures you ride in style, space, and safety..</p>
            </div>

            <div class="product-content">
                
                <div class="product-details">
                    <h3 class="text-3xl font-semibold text-text-light mb-4">5-Seater Cars to Tempo Travellers</h3>
                    <p class="text-text-subtle mb-4 text-base">
                    <li> <Strong> Ecco Car  </Strong></li>
                    <li> <Strong> Ertiga Car  </Strong></li> 
                    <li> <Strong> Swift Car  </Strong></li>
                    <li> <Strong> Tempo Traveller </Strong></li>
                    <li> <Strong> More Vehicle  </Strong></li>    
                    </p>
                    
                    <div class="price-container">
                        <div class="original-price">Final Price Varies by KM</div>
                        <div class="current-price" id="displayPrice">Select Vehicle Type</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="participate-btn">
                            <i class="fas fa-car-side"></i> Book Vehicle Now
                        </button>
                        <button id="price-list-btn" class="btn btn-secondary">
                            <i class="fas fa-tags"></i> Base Price & Per KM Rate
                        </button>
                         <button id="conditions-btn" class="btn btn-secondary">
                            <i class="fas fa-file-contract"></i> Booking Conditions
                        </button>
                        <button class="btn btn-secondary" onclick="window.open('index.html')">
                            <i class="fas fa-home"></i> Back To Home
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="stat-grid">
            <div class="stat-card">
                <h3>Total Trips Completed</h3>
                <p>50,000+</p>
            </div>
            <div class="stat-card">
                <h3>Vehicles Available</h3>
                <p>25+</p>
            </div>
            <div class="stat-card">
                <h3>Customer Satisfaction Score</h3>
                <p>4.9/5 Stars</p>
            </div>
            <div class="stat-card">
                <h3>Quickest Availability</h3>
                <p>Now!</p>
            </div>
        </div>
    </main>

    <div id="popup-overlay"></div>
    
    <!-- Service Booking Form (popupForm) -->
    <div class="popup" id="popupForm">
        <h2 class="text-2xl font-bold text-center">Vehicle Booking Form</h2>
        <form id="lotteryForm">
            <div class="quantity-selector-container my-4">
                <label>Select Vehicle Type(s):</label>
                <div id="selectedServiceCategoriesDisplay" class="p-3 rounded-lg cursor-pointer text-center text-lg" onclick="openServiceCategorySelectionPopup()">Click to select vehicle type(s)</div>
                
                <!-- Inner Popup for Model Selection -->
                <div id="serviceCategorySelectionPopup" class="popup" style="display: none;">
                    <h3 class="text-xl font-bold text-center mb-4 text-primary">Select Vehicle Type(s)</h3>
                    <div id="serviceCategoryCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-80 overflow-y-auto p-2">
                        <!-- Checkboxes will be populated here by JS -->
                    </div>
                    <button type="button" class="btn btn-primary mt-4 py-3" onclick="applySelectedServiceCategories()">Apply Selection</button>
                    <button type="button" class="btn btn-secondary mt-2 py-3 close-btn" onclick="closeServiceCategorySelectionPopup()">Cancel</button>
                </div>
                <!-- End Inner Popup -->

                <label for="ticketQuantity" class="mt-4">Number of Vehicles (Max 5):</label>
                <select id="ticketQuantity" name="ticketQuantity" required class="bg-bg-dark border-primary">
                    <option value="" disabled selected>Select quantity</option>
                </select>

                <div class="flex justify-between items-center mt-3 text-text-subtle text-sm">
                    <span>Quantity based total base fare</span>
                    <span class="total-price-quantity text-lg" style="color: var(--secondary) !important;">Total: ₹0</span>
                </div>
            </div>

            <label for="fullName">Your Full Name (min 10 characters)</label>
            <input type="text" id="fullName" name="field1" required placeholder="John Doe" autocomplete="name" minlength="10" />
            
            <label for="phone">Phone Number (10 digits)</label>
            <input type="tel" id="phone" name="field2" required placeholder="9876543210" autocomplete="tel" pattern="[0-9]{10}" />
            
            <label for="nightStay">Number of Night Stays (Extra ₹500/night per vehicle)</label>
            <select id="nightStay" name="field3" class="bg-bg-dark border-primary" required>
                <option value="0">No night stay (0 Nights)</option>
                <option value="1">One night stay (1 Night)</option>
                <option value="2">Two night stay (2 Nights)</option>
                <option value="3">Three night stay (3 Nights)</option>
                <option value="4">Four night stay (4 Nights)</option>
                <option value="5">Five night stay (5 Nights)</option>
            </select>
            
            <label for="location">Travel Route (e.g., Delhi To Mumbai)</label>
            <input type="text" id="location" name="field5" required placeholder="Delhi To Chandigarh" autocomplete="address-level2" list="locations" />
            
            <label for="address">Pickup/Drop Address Details (min 30 characters)</label>
            <textarea id="address" name="field6" required placeholder="House No, Street, Area, Landmark, City, State, PIN code, and desired pick-up time" autocomplete="street-address" minlength="30" rows="4"></textarea>

            <input type="hidden" name="ticket" id="ticketCode" />
            <input type="hidden" name="finalPrice" id="finalPrice" />
            
            <button type="submit">Submit Details & Proceed to Payment</button>
            <p id="submitMessage" class="text-center mt-3 text-primary text-sm font-semibold" style="display: none;">Submitting... Please wait</p>
        </form>
    </div>
    
    <!-- Payment Step (paymentStep) -->
    <div class="popup" id="paymentStep">
        <h2 class="text-2xl font-bold text-center">Finalize Payment</h2>
        <p class="text-text-subtle text-center mb-6">Complete the payment to confirm your Vehicle Booking.</p>
        <div id="paymentSummary" class="bg-bg-dark p-5 rounded-lg mb-6 text-center border border-secondary"></div>
        <div id="timerDisplay" class="text-xl font-bold text-primary text-center mb-4">Time remaining: 05:00</div>
        <button id="razorpay-payment-btn"><i class="fas fa-credit-card mr-2"></i> Pay with Razorpay</button>
        <p class="mt-4 text-xs text-text-subtle text-center">
            Note: The amount paid covers the base fare and night charges. Final amount based on actual KM/Tolls is settled with the driver.
        </p>
    </div>

    <!-- Ticket Confirmation (ticketStep) -->
    <div class="popup" id="ticketStep">
        <h2 id="welcomeMessage" class="text-2xl font-bold text-center text-primary"></h2>
        <p class="text-text-subtle text-center mb-4">Your booking is confirmed. Details below for <span id="ticketCountDisplay" class="font-bold text-secondary"></span>:</p>
        <div id="ticketDisplay" class="space-y-2"></div>
        <button id="downloadTicketsBtn" class="mt-4">
            <i class="fas fa-download mr-2"></i> Download Booking Details
        </button>
        <p class="mt-4 text-sm text-text-subtle text-center">📸 Please take a screenshot for proof and reference.</p>
        <button id="okayBtn" class="w-full btn-secondary mt-4 close-btn">Okay, Got It!</button>
    </div>
    
    <!-- Price List Popup (priceListPopup) -->
    <div class="popup" id="priceListPopup">
        <h2 class="text-2xl font-bold text-center">Vehicle Booking Transparent Price List</h2>
        <div id="priceListContainer" class="overflow-x-auto mt-4">
            <table class="min-w-full bg-bg-dark rounded-lg border border-primary">
                <thead>
                    <tr class="text-left text-secondary">
                        <th class="py-3 px-4 border-b border-text-subtle">Vehicle Type</th>
                        <th class="py-3 px-4 border-b border-text-subtle text-right">Base Fare (&lt; 80KM)</th>
                        <th class="py-3 px-4 border-b border-text-subtle text-right">Rate Above 80 KMs</th>
                        <th class="py-3 px-4 border-b border-text-subtle text-right">Night Charge/Night</th>
                    </tr>
                </thead>
                <tbody id="priceListTableBody">
                    <!-- Content populated by JS -->
                </tbody>
            </table>
        </div>
        <button id="closePriceListBtn" class="btn btn-secondary close-btn mt-4">Close Price List</button>
    </div>

    <!-- Conditions Popup (conditionsPopup) -->
    <div class="popup" id="conditionsPopup">
        <h2 class="text-2xl font-bold text-center">Detailed Booking Conditions</h2>
        <div id="conditionsContent" class="text-text-subtle text-base space-y-4 max-h-[70vh] overflow-y-auto pr-3">
            <h3 class="text-xl font-semibold text-primary mt-4"><i class="fas fa-route mr-2"></i> Pricing Structure</h3>
            <ul class="list-disc list-inside space-y-2 pl-4">
                <li> A fixed All-Vehicle Booking Rate applies to all appointments within a 80 km radius from our base location.</li>
                <li> Extended Travel (Beyond 80 km) Then Per KM Rate will Be charge ( Eg. 100 Km Then extra KM Charge apply as Memtioned in Rate Table</li> 
                <li>**Night Charges:** A flat fee (₹500 per night Charge) applies for each night stay selected. This fee is **included in your initial payment**.</li>
                <li>**Tolls/Parking:** All road tolls, state taxes, and parking fees are excluded from the fare and must be paid directly by the customer.</li>
            </ul>

            <h3 class="text-xl font-semibold text-primary mt-6"><i class="fas fa-car mr-2"></i> Vehicle Details</h3>
            <ul class="list-disc list-inside space-y-2 pl-4">
                <li>All vehicles are well-maintained and commercially registered.</li>
                <li>Booking confirms the vehicle *type* (e.g., ECCO, Tempo Traveller), not a specific model or color.</li>
                <li>The maximum number of passengers is strictly enforced as per RTO guidelines for the selected vehicle type.</li>
            </ul>
            
            <h3 class="text-xl font-semibold text-primary mt-6"><i class="fas fa-receipt mr-2"></i> Booking & Payment Terms</h3>
            <ul class="list-disc list-inside space-y-2 pl-4">
                <li>Your payment covers the **Base Fare + Night Stay Charges**.</li>
                <li>The driver will contact you via phone shortly after booking confirmation.</li>
                <li>We recommend confirming all final rates, per KM charges, and expected travel time with the driver before starting the journey.</li>
                <li>**Cancellations:** Subject to a fee if canceled within 4 hours of the scheduled pickup time.</li>
            </ul>
        </div>
        <button id="closeConditionsBtn" class="btn btn-secondary close-btn mt-4">I Understand</button>
    </div>
   
    <script>
        // --- Google Sheet Constants (Shared Link from AC Service File) ---
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbwvO8RKxi2zxIZsilgYB74V_kO00EQIA_QIefdhsv9Dv0cEgh300B8kx6WsjHzpXnA1gg/exec";

        // Data for vehicle booking services (Rates updated as per latest chart: Base fare < 80KM, PerKM > 80KM)
        const serviceData = [
            {"Name": "ECCO 5 Seater", "Price": 1699, "PerKM": "10 Rs./KM", "NightCharge": 500}, 
            {"Name": "Desire 5 Seater", "Price": 1799, "PerKM": "11 Rs./KM", "NightCharge": 500}, 
            {"Name": "Ertiga 7 Seater", "Price": 2299, "PerKM": "14 Rs./KM", "NightCharge": 500}, 
            {"Name": "Tempo Traveller (9-12 Seater)", "Price": 6250, "PerKM": "25 Rs./KM", "NightCharge": 500},
            {"Name": "Tempo Traveller (15-18 Seater)", "Price": 6750, "PerKM": "27 Rs./KM", "NightCharge": 500},
            {"Name": "Tempo Traveller (18-21 Seater)", "Price": 6750, "PerKM": "27 Rs./KM", "NightCharge": 500},
            {"Name": "Tempo Traveller (25 Seater)", "Price": 8750, "PerKM": "35 Rs./KM", "NightCharge": 500},
        ];

        // --- Constants and DOM Element Selection ---
        const SERVICE_NAME = "Vehicle Booking";
        const SERVICE_TAB_ID = "vehicle-booking";
        const SERVICE_FORM_DATA_KEY = "field4"; // Field 4 for selected vehicle names
        const RAZORPAY_IMAGE_TEXT = "VB";

        const participateBtn = document.getElementById('participate-btn');
        const popupOverlay = document.getElementById('popup-overlay');
        const allPopups = document.querySelectorAll('.popup');
        const popupForm = document.getElementById('popupForm');
        const paymentStep = document.getElementById('paymentStep');
        const ticketStep = document.getElementById('ticketStep');
        const timerDisplay = document.getElementById('timerDisplay');
        const razorpayBtn = document.getElementById('razorpay-payment-btn');
        const submitMessage = document.getElementById('submitMessage');
        const serviceCategoryCheckboxesContainer = document.getElementById('serviceCategoryCheckboxes');
        const selectedServiceCategoriesDisplay = document.getElementById('selectedServiceCategoriesDisplay');
        const serviceCategorySelectionPopup = document.getElementById('serviceCategorySelectionPopup');
        const ticketQuantitySelect = document.getElementById('ticketQuantity');
        const totalPriceQuantityDisplay = document.querySelector('.total-price-quantity');
        const paymentSummary = document.getElementById('paymentSummary');
        const ticketCountDisplay = document.getElementById('ticketCountDisplay');
        const downloadTicketsBtn = document.getElementById('downloadTicketsBtn');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const displayPriceElement = document.getElementById('displayPrice');
        const finalPriceInput = document.getElementById('finalPrice');
        const form = document.getElementById('lotteryForm');
        const ticketDisplay = document.getElementById('ticketDisplay');
        const okayBtn = document.getElementById('okayBtn');
        const nightStaySelect = document.getElementById('nightStay'); 

        const priceListBtn = document.getElementById('price-list-btn');
        const conditionsBtn = document.getElementById('conditions-btn');
        const priceListPopup = document.getElementById('priceListPopup');
        const conditionsPopup = document.getElementById('conditionsPopup');
        const closePriceListBtn = document.getElementById('closePriceListBtn');
        const closeConditionsBtn = document.getElementById('closeConditionsBtn');
        const priceListTableBody = document.getElementById('priceListTableBody');
        const priceListContainer = document.getElementById('priceListContainer');

        // --- State Variables ---
        let generatedTicket = ''; 
        let paymentTimeout = null;
        let countdownInterval = null;
        const PAYMENT_TIME_LIMIT = 5 * 60; // 5 minutes
        let currentServicePrice = 0; // Represents total base fare for all selected vehicles (single quantity)
        let totalNightChargesPerVehicle = 0; // Total night charge for all selected vehicles (single quantity, 1 night)
        let selectedQuantity = 1;
        let allowClose = false;
        const LOCAL_STORAGE_KEY = 'vehicleBookingFormData'; 
        
        // --- Core Functions ---

        function saveFormData() {
            const formData = {
                fullName: form.field1.value,
                phone: form.field2.value,
                location: form.field5.value,
                address: form.field6.value,
                nightStay: nightStaySelect.value
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                form.field1.value = data.fullName || '';
                form.field2.value = data.phone || '';
                form.field5.value = data.location || '';
                form.field6.value = data.address || '';
                nightStaySelect.value = data.nightStay || '0';
            }
        }
        
        function populateServiceCategories() {
            serviceCategoryCheckboxesContainer.innerHTML = '';
            serviceData.forEach(service => {
                // Displaying the base price in the checkbox label
                const checkboxHtml = `
                    <label class="inline-flex items-center text-text-light w-full p-2 bg-bg-dark rounded-md border border-primary hover:bg-bg-card transition duration-200 cursor-pointer">
                        <input type="checkbox" name="serviceCategory" value="${service.Name}" 
                               data-price="${service.Price}" 
                               data-night-charge="${service.NightCharge}"
                               class="form-checkbox h-5 w-5 text-secondary rounded focus:ring-secondary checked:bg-secondary">
                        <span class="ml-2 text-sm">${service.Name} (<span class="text-secondary">₹${service.Price}</span>)</span>
                    </label>
                `;
                serviceCategoryCheckboxesContainer.insertAdjacentHTML('beforeend', checkboxHtml);
            });
            serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]').forEach(checkbox => {
                checkbox.removeEventListener('change', updatePrices);
                checkbox.addEventListener('change', updatePrices);
            });
        }

        function initQuantitySelector() {
            const maxServices = 5; 
            ticketQuantitySelect.innerHTML = '<option value="" disabled selected>Select quantity</option>';
            for (let i = 1; i <= maxServices; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + (i === 1 ? ' vehicle' : ' vehicles');
                ticketQuantitySelect.appendChild(option);
            }
            ticketQuantitySelect.value = 1;
        }

        function updatePrices() {
            const selectedCategories = Array.from(serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]:checked'));
            selectedQuantity = parseInt(ticketQuantitySelect.value) || 1;
            const selectedNightStay = parseInt(nightStaySelect.value) || 0; 

            let unitBasePriceSum = 0; 
            totalNightChargesPerVehicle = 0; 
            
            if (selectedCategories.length > 0) {
                selectedCategories.forEach(checkbox => {
                    unitBasePriceSum += parseFloat(checkbox.dataset.price);
                    // FIX: Use camelCase for dataset property access
                    totalNightChargesPerVehicle += parseFloat(checkbox.dataset.nightCharge); 
                });
            }
            
            // Calculate final price:
            // (Total Base Price * Quantity) + (Total Night Charge * Quantity * Nights)
            const baseFareComponent = unitBasePriceSum * selectedQuantity;
            const nightChargeComponent = totalNightChargesPerVehicle * selectedQuantity * selectedNightStay;
            
            const totalFinalPrice = baseFareComponent + nightChargeComponent;
            
            currentServicePrice = unitBasePriceSum; // Keep this as the single-unit base price for simple display

            if (selectedCategories.length > 0) {
                selectedServiceCategoriesDisplay.textContent = selectedCategories.map(cb => cb.value).join(', ');
                displayPriceElement.textContent = `Base Fare: ₹${unitBasePriceSum}`;
            } else {
                selectedServiceCategoriesDisplay.textContent = 'Click to select vehicle type(s)';
                displayPriceElement.textContent = 'Select Vehicle Type';
            }
            
            totalPriceQuantityDisplay.textContent = `Total: ₹${totalFinalPrice}`;
            finalPriceInput.value = totalFinalPrice;
            
            // Re-check previously selected items if inner popup is open
            if (serviceCategorySelectionPopup.style.display === 'block') {
                const currentlySelected = selectedServiceCategoriesDisplay.textContent.split(', ').map(s => s.trim()).filter(s => s && s !== 'Click to select vehicle type(s)');
                serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]').forEach(cb => {
                    cb.checked = currentlySelected.includes(cb.value);
                });
            }
        }

        function generateFormattedTicket() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16).toUpperCase();
            });
        }

        function downloadTickets() {
            const selectedCategoryNames = Array.from(serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]:checked')).map(cb => cb.value).join(', ');
            const selectedNightStayText = nightStaySelect.options[nightStaySelect.selectedIndex].text;
            
            const ticketContent = `${SERVICE_NAME} Booking Details\n\n` +
                                 `Customer Name: ${form.field1.value}\n` +
                                 `Contact: ${form.field2.value}\n` +
                                 `Night Stay: ${selectedNightStayText}\n` +
                                 `Route: ${form.field5.value}\n` +
                                 `Vehicle(s): ${selectedCategoryNames}\n` +
                                 `Booking Reference Number: ${generatedTicket}\n\n` + 
                                 `Total Vehicles: ${selectedQuantity}\n` +
                                 `Amount Paid (Base + Night Charges): ₹${finalPriceInput.value}\n\n` +
                                 `--- IMPORTANT NOTE ---\n` +
                                 `The final amount based on actual KM travelled and Tolls is payable directly to the driver.`;
            
            const blob = new Blob([ticketContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${SERVICE_TAB_ID}_booking_${generatedTicket.substring(0, 8)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showCustomAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert'; 
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 4000); 
        }

        // --- Popup Control Functions ---
        function clearTimers() {
            if (paymentTimeout) clearTimeout(paymentTimeout);
            if (countdownInterval) clearInterval(countdownInterval);
        }

        function closeAllPopups() {
            if (!allowClose) {
                showCustomAlert("Please complete the booking process before closing.");
                return;
            }
            clearTimers();
            popupOverlay.style.display = 'none';
            allPopups.forEach(p => p.style.display = 'none');
            document.body.style.overflow = 'auto';
            allowClose = false; 
        }

        function openPopup(popupElement) {
            document.body.style.overflow = 'hidden';
            popupOverlay.style.display = 'block';
            allPopups.forEach(p => p.style.display = 'none');
            popupElement.style.display = 'block';
            allowClose = false;
        }
        
        function closeSpecificPopup(popupElement) {
            popupElement.style.display = 'none';
            const isAnotherPopupOpen = Array.from(allPopups).some(p => p.style.display === 'block');
            if (!isAnotherPopupOpen) {
                popupOverlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function openServiceCategorySelectionPopup() {
            populateServiceCategories(); 
            
            const currentlySelected = selectedServiceCategoriesDisplay.textContent.split(', ').map(s => s.trim()).filter(s => s && s !== 'Click to select vehicle type(s)');
            serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]').forEach(cb => {
                cb.checked = currentlySelected.includes(cb.value);
            });
            
            serviceCategorySelectionPopup.style.display = 'block';
            popupOverlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeServiceCategorySelectionPopup() {
            serviceCategorySelectionPopup.style.display = 'none';
            if (popupForm.style.display !== 'block' && priceListPopup.style.display !== 'block' && conditionsPopup.style.display !== 'block') {
                popupOverlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function applySelectedServiceCategories() {
            updatePrices();
            closeServiceCategorySelectionPopup();
        }

        // --- Timer Functions ---
        function startPaymentTimer() {
            let timeLeft = PAYMENT_TIME_LIMIT;
            const updateDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `Time remaining: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };
            updateDisplay();

            countdownInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showCustomAlert("Payment time expired. Please try again.");
                    allowClose = true; 
                    closeAllPopups();
                }
            }, 1000);
        }

        // --- Price List Function ---
        function populatePriceList() {
            priceListTableBody.innerHTML = '';
            serviceData.forEach(service => {
                const row = `
                    <tr class="text-text-light hover:bg-bg-dark">
                        <td class="py-3 px-4 border-b border-gray-700">${service.Name}</td>
                        <td class="py-3 px-4 border-b border-gray-700 text-right font-semibold text-secondary">₹${service.Price}</td>
                        <td class="py-3 px-4 border-b border-gray-700 text-right font-semibold text-primary">${service.PerKM}</td>
                        <td class="py-3 px-4 border-b border-gray-700 text-right font-semibold text-secondary">₹${service.NightCharge}</td>
                    </tr>
                `;
                priceListTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Payment and Submission Logic ---
        
        function handleFormSubmit(e) {
            e.preventDefault();

            // Validation 
            const selectedCategories = Array.from(serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]:checked'));
            if (selectedCategories.length === 0) { showCustomAlert("Please select at least one Vehicle Type."); return; }
            if (form.fullName.value.trim().length < 10) { showCustomAlert("Please enter your full name (minimum 10 characters)."); return; }
            if (!/^\d{10}$/.test(form.phone.value.trim())) { showCustomAlert("Please enter a valid 10-digit phone number."); return; }
            if (form.location.value.trim().length < 3) { showCustomAlert("Please enter a valid travel route (e.g., City A to City B)."); return; }
            if (form.address.value.trim().length < 30) { showCustomAlert("Please enter complete pickup/drop address details (minimum 30 characters)."); return; }
            if (!ticketQuantitySelect.value || parseInt(ticketQuantitySelect.value) <= 0) { showCustomAlert("Please select the number of vehicles."); return; }

            submitMessage.style.display = 'block';
            form.querySelector('button[type="submit"]').disabled = true;

            generatedTicket = generateFormattedTicket(); 
            
            const selectedCategoryNames = selectedCategories.map(cb => cb.value).join(', ');
            const selectedNightStayText = nightStaySelect.options[nightStaySelect.selectedIndex].text;

            // --- Form Data for Google Sheet ---
            const formData = new FormData();
            formData.append('field1', form.fullName.value); 
            formData.append('field2', form.phone.value);    
            formData.append('field3', nightStaySelect.value); // Night Stay count
            formData.append(SERVICE_FORM_DATA_KEY, selectedCategoryNames); 
            formData.append('field5', form.location.value); // Route
            formData.append('field6', form.address.value);  // Address
            formData.append('ticket', generatedTicket);     
            formData.append('tab', SERVICE_TAB_ID);           
            formData.append('serviceType', 'Vehicle Booking');   
            formData.append('servicePrice', finalPriceInput.value); // Final calculated price
            formData.append('ticketQuantity', selectedQuantity); 

            // --- Google Script Submission using GOOGLE_SHEET_URL ---
            fetch(GOOGLE_SHEET_URL, {
                method: "POST",
                body: formData
            })
            .then(res => res.text())
            .then(res => {
                if (res.includes("Success") || res.includes("success")) { 
                    saveFormData(); 
                    
                    popupForm.style.display = 'none';
                    openPopup(paymentStep);
                    paymentSummary.innerHTML = `
                        <p class="text-text-subtle text-lg mb-2 font-bold">Booking Details:</p>
                        <p class="text-text-light text-base mb-1">Vehicle(s): <span class="font-bold text-primary">${selectedCategoryNames}</span></p>
                        <p class="text-text-light text-base mb-1">Night Stay: <span class="font-bold text-primary">${selectedNightStayText}</span></p>
                        <p class="text-text-light text-base mb-3">Quantity: <span class="font-bold text-primary">${selectedQuantity}</span></p>
                        <p class="current-price text-secondary text-3xl font-bold">Total Payable: ₹${finalPriceInput.value}</p>
                        <p class="text-gray-400 text-sm mt-2">This includes the Base Fare and Night Charges. KM rate/Tolls are extra.</p>
                    `;
                    startPaymentTimer();
                } else {
                    showCustomAlert("Booking Error: There was an issue submitting your details. Please try again.");
                }
            })
            .catch(err => {
                console.error("Submission error:", err);
                showCustomAlert("Network Error: An unexpected error occurred. Please check your connection and try again.");
            })
            .finally(() => {
                submitMessage.style.display = 'none';
                form.querySelector('button[type="submit"]').disabled = false;
            });
        }

        function handleRazorpayPayment() {
            const selectedCategoryNames = Array.from(serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]:checked')).map(cb => cb.value).join(', ');
            const selectedNightStayText = nightStaySelect.options[nightStaySelect.selectedIndex].text;
            
            const options = {
                "key": "rzp_live_RLjzp7VlXERwiG",
                "amount": finalPriceInput.value * 100, // Amount in paise
                "currency": "INR",
                "name": `SonipatHomeService - ${SERVICE_NAME}`,
                "description": `Payment for ${selectedQuantity} ${SERVICE_NAME} vehicle(s) (${selectedNightStayText})`,
                "image": `https://placehold.co/100x100/1C2738/FFC72C?text=${RAZORPAY_IMAGE_TEXT}`, 
                "handler": function (response){
                    console.log("Payment successful:", response.razorpay_payment_id);
                    paymentSuccess(response.razorpay_payment_id);
                },
                "prefill": {
                    "name": form.fullName.value,
                    "contact": form.phone.value
                },
                "notes": {
                    "address": `${form.location.value}, ${form.address.value}`,
                    "service_details": selectedCategoryNames,
                    "booking_ref": generatedTicket,
                    "night_stay_count": nightStaySelect.value
                },
                "theme": { "color": "#00FFFF" },
                "modal": { "ondismiss": () => console.log('Razorpay checkout modal closed.') }
            };

            const rzp = new Razorpay(options);
            rzp.on('payment.failed', response => {
                console.error("Payment Failed:", response.error);
                showCustomAlert(`Payment Failed: ${response.error.description} (Code: ${response.error.code})`);
            });
            rzp.open();
        }

        function paymentSuccess(paymentId) {
            clearTimers();
            paymentStep.style.display = 'none';
            openPopup(ticketStep);
            
            const userName = form.fullName.value.split(' ')[0];
            const selectedCategoryNames = Array.from(serviceCategoryCheckboxesContainer.querySelectorAll('input[name="serviceCategory"]:checked')).map(cb => cb.value).join(', ');
            const selectedNightStayText = nightStaySelect.options[nightStaySelect.selectedIndex].text;

            welcomeMessage.textContent = `🎉 Bravo, ${userName}! Booking Confirmed! 🎉`;
            
            ticketDisplay.innerHTML = `
                <p>Booking ID: <span class="font-bold text-text-light">${generatedTicket}</span></p>
                <p>Vehicle(s): <span class="font-bold text-text-light">${selectedCategoryNames}</span></p>
                <p>Route: <span class="font-bold text-text-light">${form.location.value}</span></p>
                <p>Night Stay: <span class="font-bold text-text-light">${selectedNightStayText}</span></p>
                <p class="text-secondary text-lg font-bold mt-3">Amount Paid: ₹${finalPriceInput.value}</p>
                <p class="text-text-subtle text-sm mt-3">The driver will contact you shortly to confirm pickup details at: ${form.address.value.substring(0, 50)}...</p>
                <p class="text-text-subtle text-xs mt-1">Payment ID: ${paymentId}</p>
            `;
            
            ticketCountDisplay.textContent = `${selectedQuantity} Vehicle(s)`;
            allowClose = true;
        }
        
        // --- Event Listeners Initialization ---
        participateBtn.addEventListener('click', () => {
            initQuantitySelector();
            updatePrices();
            openPopup(popupForm);
        });
        
        ticketQuantitySelect.addEventListener('change', updatePrices); 
        nightStaySelect.addEventListener('change', updatePrices); // Added listener for Night Stay
        
        // Centralized Overlay Click Handling
        popupOverlay.addEventListener('click', e => {
            if (e.target === popupOverlay) {
                if (serviceCategorySelectionPopup.style.display === 'block') closeServiceCategorySelectionPopup();
                else if (priceListPopup.style.display === 'block') closeSpecificPopup(priceListPopup);
                else if (conditionsPopup.style.display === 'block') closeSpecificPopup(conditionsPopup);
                else if (ticketStep.style.display === 'block' && allowClose) closeAllPopups();
                else if (popupForm.style.display === 'block' || paymentStep.style.display === 'block') showCustomAlert("Please complete the booking process before closing.");
                else closeAllPopups();
            }
        });
        
        // Popup Close buttons
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parentPopup = e.target.closest('.popup');
                if (parentPopup.id === 'ticketStep') {
                    window.location.href = 'index.html';
                } else {
                    closeSpecificPopup(parentPopup);
                }
            });
        });

        // Specific listeners
        okayBtn.addEventListener('click', () => window.location.href = 'index.html');
        razorpayBtn.addEventListener('click', handleRazorpayPayment);
        downloadTicketsBtn.addEventListener('click', downloadTickets);
        form.addEventListener('submit', handleFormSubmit);

        // Listeners for info popups
        priceListBtn.addEventListener('click', () => {
            populatePriceList();
            openPopup(priceListPopup);
        });
        conditionsBtn.addEventListener('click', () => openPopup(conditionsPopup));


        // --- Page Load Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateServiceCategories(); 
            initQuantitySelector();
            loadFormData(); 
            updatePrices(); 
        });
    </script>
</body>
</html>
